<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta content='text/html; charset=utf-8' http-equiv='content-type'>
        <title>multitwitchchat - provides a fast way to get chatrooms of all  your favorite twitch streams.</title>
        <meta name="description" content='Search for twitch streamers and open just the chat for each one.'>
        <meta name='keywords' content='multitwitchchat takbytes.com multiple twitchchat'>
        <meta name='author' content='takada'>
        <link rel='stylesheet' href='css/main.css'>
        <link rel='stylesheet' href='css/redmond/jquery-ui-1.10.4.custom.min.css'>
<!--load JQuery before Angular-->
        <script src='js/jquery-1.10.2.js'></script>
        <!-- <script src='js/jquery-2.1.1.min.js'></script> -->
        <script src='js/jquery-ui-1.10.4.custom.min.js'></script>
<!-- JQuery Plugins -->
<!--        <script src='js/jquery.marquee.min.js'></script> -->
<!-- Angularjs -->
        <script src='js/angular.min.1.3.0b10.js'></script>
        <script src='js/angular-sanitize.min.1.3.0b10.js'></script>
        <script src='js/ngStorage.min.js'></script>
        <script src='js/jquery.typing-0.2.0.min.js'></script>
    </head>

<script>

/* Similar to what you find in Java's format. */
/* Usage: chatsrc = 'http://twitch.tv/chat/embed?channel={channel}&amp;popout_chat=true'.format({ channel: streamer}); */
if (!String.prototype.format) {
    String.prototype.format = function() {
        var str = this.toString();
        if (!arguments.length)
            return str;
        var args = typeof arguments[0],
            args = (('string' == args || 'number' == args) ? arguments : arguments[0]);
        for (arg in args)
            str = str.replace(RegExp('\\{' + arg + '\\}', 'gi'), args[arg]);
        return str;
    }
}

//Bootstrap the application. and add the very important compile module.
var app = angular.module('app', ['ngSanitize', 'ngStorage'], ['$compileProvider', function($compileProvider) {
 $compileProvider.directive('myCompileUnsafe', ['$compile', function($compile) {
    return function(scope, element, attrs) {
      scope.$watch(
            function(scope) {
                // watch the 'compile' expression for changes
                return scope.$eval(attrs.myCompileUnsafe);
            },
            function(value) {
                // when the 'compile' expression changes
                // assign it into the current DOM element
                element.html(value);

                // compile the new DOM and link it to the current
                // scope.
                // NOTE: we only compile .childNodes so that
                // we don't get into infinite loop compiling ourselves
                $compile(element.contents())(scope);
            }
            );
        };
    }]);
}]);


app.controller('MainController', function($scope,$location,$localStorage) {
    $scope.searchtext = '';
    $scope.searchresults = [];

    $scope.storage = $localStorage.$default({
        savedstreamers: []
    });

    $scope.savedstreamers = $scope.storage.savedstreamers;
});

app.directive('draggable', function() {
    return {
        restrict: 'AEC',
        link: function($scope, $element) {
            $element.draggable({
                containment: '#center',
                stack: '.set'
            });
        }
    };
});

/* Handles images point to wrong url */
app.directive('errSrc', function() {
    return {
        link: function($scope, $element, $attrs) {

            $scope.$watch(function() { return $attrs['ngSrc']; },
            function (value) {
                if (!value) {
                    $element.attr('src', $attrs.errSrc);
                }
            });

            $element.bind('error', function() {
                $element.attr('src', $attrs.errSrc);
            });
        }
    }
});

app.directive('loadChat', ['$compile', function($compile) {
    return {
        restrict: 'AEC',
        scope: {
            insertionpoint: '@',
            savedstreamers: '='
        },
        controller: function($scope, $element, $attrs) {
            $scope.colors = [ 'SlateGray','SlateGrey','Snow','White','WhiteSmoke'];

            $scope.getRandomSpan = function(){
                return Math.floor((Math.random()*6)+1);
            }

            $scope.add = function(insertionpoint, stream) {

                // Source(src) of the chat with streamname.
                var chatsrc = 'http://twitch.tv/chat/embed?channel={ch}&amp;popout_chat=true'.format({
                    ch: stream.streamname});

                // iframe of the chat goes into a twitchchat div that's draggable.
                var chat =    [ '<iframe ',
                    'id=\'_{name}\' '.format({ name: stream.streamname}),
                    'frameborder=\'0\' ',
                    'scrolling=\'yes\' ',
                    'src=\'{url}\' '.format({url: chatsrc}),
                     'width=\'{w}\' '.format({w: 310}),
                    'height=\'{h}\' '.format({h: 540}),
                     '> ',
                '</iframe>'].join('');

                // Update the color upon adding a new div.
                $scope.color = $scope.colors[Math.floor(Math.random() * $scope.colors.length)]; //$scope.colors.length = 147

                var html = ["<div id='twitchchat' class='set {uid}' style='background-color: {color}' draggable>".format({color: $scope.color, uid: stream.streamname}), // resizable
                            "<span style='position: absolute; margin: 20px 0px 0px 20px;'>{chat}</span>".format({chat: chat}),
                            "<img ng-src='{logo}' class='topcornerlogo' width='50' height='50' err-src='img/twitchchat.jpg'>".format({logo: stream.logo}),
                            "</div>"
                            ].join(''); //Html from above all together.

                // Compile html with angular.
                var compiledhtml = $compile(html)($scope);

                // Append the compiled html(chat) to insertionpoint
                $('#'+insertionpoint).append(compiledhtml);
            }

            // Load all the saved chats from session.
            for (i = 0; i < $scope.savedstreamers.length; i++) {
                $scope.add($scope.insertionpoint, $scope.savedstreamers[i]);
            }
        }
    };
}]);

/* Creates multiple from clicking streams from search */
app.directive('multiChat', ['$compile', function($compile) {
    return {
        restrict: 'AEC',
        scope: {
            insertionpoint: '@',
            streamname: '@',
            logo: '@',
            savedstreamers: '='
        },
        link: function($scope, $element, $attrs) {
            $element.bind('click', function(e) {
                console.log($scope.logo);
                var stream = { streamname: $scope.streamname, logo: $scope.logo };
                var index = $scope.savedstreamers.indexOf(stream);

                if ($scope.savedstreamers.length >= 8) { // Set a maximum number of streams allowed opened.
                    return -1;
                }

                // Do not allow duplicate streams. (Note: this is pretty slow as it has go through whole array to find a duplicate.)
                for (i = 0; i < $scope.savedstreamers.length; i++) {
                    console.log($scope.savedstreamers[i]);
                    if (stream.streamname == $scope.savedstreamers[i].streamname) {
                        console.log('match found: ' + $scope.savedstreamers[i].streamname + ' - will not be added to session.');
                        return -1;
                    }
                };

                // Add chat to session array to keep track of it.
                $scope.$apply(function() {
                    $scope.savedstreamers.push(stream);
                });

                // Add chat to insertionpoint.
                $scope.add($scope.insertionpoint, stream);
            });

            $scope.colors = ['AliceBlue','AntiqueWhite','Aqua','Aquamarine','Azure','Beige','Bisque','Black','BlanchedAlmond','Blue','BlueViolet','Brown','BurlyWood','CadetBlue','Chartreuse',
                      'Chocolate','Coral','CornflowerBlue','Cornsilk','Crimson','Cyan','DarkBlue','DarkCyan','DarkGoldenRod','DarkGray','DarkGrey','DarkGreen','DarkKhaki','DarkMagenta',
                      'DarkOliveGreen','Darkorange','DarkOrchid','DarkRed','DarkSalmon','DarkSeaGreen','DarkSlateBlue','DarkSlateGray','DarkSlateGrey','DarkTurquoise','DarkViolet','DeepPink',
                      'DeepSkyBlue','DimGray','DimGrey','DodgerBlue','FireBrick','FloralWhite','ForestGreen','Fuchsia','Gainsboro','GhostWhite','Gold','GoldenRod','Gray','Grey','Green','GreenYellow',
                      'HoneyDew','HotPink','IndianRed','Indigo','Ivory','Khaki','Lavender','LavenderBlush','LawnGreen','LemonChiffon','LightBlue','LightCoral','LightCyan','LightGoldenRodYellow','LightGray',
                      'LightGrey','LightGreen','LightPink','LightSalmon','LightSeaGreen','LightSkyBlue','LightSlateGray','LightSlateGrey','LightSteelBlue','LightYellow','Lime','LimeGreen','Linen','Magenta',
                      'Maroon','MediumAquaMarine','MediumBlue','MediumOrchid','MediumPurple','MediumSeaGreen','MediumSlateBlue','MediumSpringGreen','MediumTurquoise','MediumVioletRed','MidnightBlue',
                      'MintCream','MistyRose','Moccasin','NavajoWhite','Navy','OldLace','Olive','OliveDrab','Orange','OrangeRed','Orchid','PaleGoldenRod','PaleGreen','PaleTurquoise','PaleVioletRed',
                      'PapayaWhip','PeachPuff','Peru','Pink','Plum','PowderBlue','Purple','Red','RosyBrown','RoyalBlue','SaddleBrown','Salmon','SandyBrown','SeaGreen','SeaShell','Sienna','Silver',
                      'SkyBlue','SlateBlue','SlateGray','SlateGrey','Snow','SpringGreen','SteelBlue','Tan','Teal','Thistle','Tomato','Turquoise','Violet','Wheat','White','WhiteSmoke','Yellow','YellowGreen'];

            $scope.getRandomSpan = function(){
                return Math.floor((Math.random()*6)+1);
            }

            $scope.add = function(insertionpoint, stream) {
                res = calcResolutions();

                // Source(src) of the chat with streamname.
                var chatsrc = 'http://twitch.tv/chat/embed?channel={ch}&amp;popout_chat=true'.format({
                    ch: stream.streamname});

                // iframe of the chat.
                var chat =    [ '<iframe ',
                    'id=\'_{name}\' '.format({ name: stream.streamname}),
                    'frameborder=\'0\' ',
                    'scrolling=\'yes\' ',
                    'src=\'{url}\' '.format({url: chatsrc}), //'src=\'{url}\' '.format({url: 'test'}),
                     'width=\'{w}\' '.format({w: 310}),
                    'height=\'{h}\' '.format({h: 540}),
                     'draggable> ',
                '</iframe>'].join('');

                // Update the color upon adding a new div.
                $scope.color = $scope.colors[Math.floor(Math.random() * $scope.colors.length)]; //$scope.colors.length = 147

                var html = ["<div id='twitchchat' class='set {uid}' style='background-color: {color}' draggable>".format({color: $scope.color, uid: stream.streamname}), // resizable
                            "<span style='margin: 20px 0px 0px 10px;'>{chat}</span>".format({chat: chat}),
                            "<img ng-src='{logo}' class='topcornerlogo' width='50' height='50' err-src='img/twitchchat.jpg'>".format({logo: stream.logo}),
                            "</div>"
                            ].join('');
                console.log($('.' + stream.streamname));
                var compiledhtml = $compile(html)($scope);

                $('#'+insertionpoint).append(compiledhtml);

                applyResolutions();
            }
        }
    };
}]);

app.directive('manageChats', ['$compile', function($compile) {
    return {
        restrict: 'AEC',
        controller: 'MainController',
        link: function($scope, $element, $attrs) {

            $scope.closeChat = function(stream) {
                /* Remove div with a uid inside its class */
                // $('.' + stream.streamname).effect('fade', {}, 350, function() { //streamname is the uid.
                //     $('.' + stream.streamname).remove();
                // });
                $('.' + stream.streamname).effect('fade', {}, 350, function() { //streamname is the uid.
                    console.log('test');
                    //$('#_' + stream.streamname).contentWindow.location.reload();
                    //document.getElementById('_' + stream.streamname).contentWindow.location.reload(true);
                    $('#_' + stream.streamname).empty();
                    $('.' + stream.streamname).empty();
                    setTimeout(function(){
                        $('.' + stream.streamname).remove();
                        $('#_' + stream.streamname).remove();
                    }, 1500)

                });

                var index = $scope.savedstreamers.indexOf(stream);

                if (index != -1) {
                    $scope.savedstreamers.splice(index, 1); //Remove the streamer from session.
                }
            };
        }
    };
}]);

app.directive('twitchSearch', ['$compile', function($compile){
    return {
        restrict: 'AEC',
        controller: 'MainController',
        link: function($scope, $element, $attrs) {
            $scope.search = function(streamname) {
                $.ajax({
                    url: 'https://api.twitch.tv/kraken/search/channels?q={streamname}'.format({ streamname: streamname}),

                    // The name of the callback parameter, as specified by the YQL service.
                    jsonp: "callback",

                    // Tell jQuery we're expecting JSONP.
                    dataType: "jsonp",

                    success: function( response ) {
                        $scope.$apply(function() {
                            $scope.searchresults = response.channels;
                        });

                        console.log( response ); // server response
                    }
                });
            }

            // $element.bind('propertychange keyup paste', function(blurEvent) {
            //     setTimeout($scope.search($element.val()), 0);
            // });
            $element.typing({
                start: function (event, $elem) {

                },
                stop: function (event, $elem) {
                    $scope.search($element.val());
                },
                delay: 350
            });
        },
   };
}]);

    // Generate width height for various divs.
    function calcResolutions() {
        hOffset = 32; //Height for our header
        currWinWidth = $(window).width();
        currWinHeight = $(window).height();

        headerWidth = Math.floor(currWinWidth);
        headerHeight = Math.floor(hOffset);

        containerWidth = (currWinWidth);
        containerHeight = (currWinHeight);

        centerWidth = Math.floor(currWinWidth - 250);
        centerHeight = Math.floor(currWinHeight);

        searchTwitchFormWidth = Math.floor(250);
        searchTwitchFormHeight = Math.floor(currWinHeight);

        return {
            containerW: containerWidth, containerH: containerHeight,
            headerW: headerWidth, headerH: headerHeight,
            centerW: centerWidth, centerH: centerHeight,
            searchTwitchFormW: searchTwitchFormWidth, searchTwitchFormH: searchTwitchFormHeight
        };
    }

    // Apply panel resolutions based on current window sizes to various divs.
    function applyResolutions() {
        res = calcResolutions();

        $('#container').css('width', res.containerW);
        $('#container').css('height', res.containerH);

        $('#header').css('width',res.headerW);
        $('#header').css('height',res.headerH);

        $('#center').css('width', res.centerW);
        $('#center').css('height', res.centerH);

        $('#searchTwitchForm').css('width', res.searchTwitchFormW);
        $('#searchTwitchForm').css('height', res.searchTwitchFormH);

        $('#savedChatList').css('width', res.searchTwitchFormW);
        $('#savedChatList').css('height', res.searchTwitchFormH);

        /* Header */
        $('#chatList').css('margin-left', 72); //Align image to far right properly.
        // $('#showSearch').css('margin-left', 20); //Align image to far right properly.
        $('#copyright').css('margin-left', res.headerW-120);
        $('#srlplayer').css('margin-left', 260); //Align to far right properly.
    }

    /* Main */
    $( document ).ready(function() {
        applyResolutions(); // Apply panel resolutions based on current window sizes

        $( window ).resize(function() {
            applyResolutions();
        });
    });
</script>

    <body ng-app='app'>
        <div id='container' ng-controller='MainController'>

            <div id='header'>
                <div id='chatList' class='senlightfont unselectable' style='position: absolute; margin-top: 5px; font-size: medium;
                border-radius: 4px; border-color: black; border: 1px solid; background-color: white; cursor: pointer;' ng-click="showSavedChatList = ! showSavedChatList">Manage Chats</div>
                <!-- <div id='showSearch' class='senlightfont unselectable' style='position: absolute; margin-top: 5px; font-size: medium;
                border-radius: 4px; border-color: black; border: 1px solid; background-color: white; cursor: pointer;' ng-click="!hideSavedChatList">Search</div> -->
                <div id='copyright' class='senlightfont' style='position: absolute; margin-top: 5px; font-size: medium;'>&copy; 2014 takada</div>
                <div id='srlplayer' class='senlightfont' style='position: absolute; margin-top: 5px; font-size: medium;'><a href='http://srl.takbytes.com'>srlplayer</a></div>
            </div>

            <div id='savedChatList' ng-show='showSavedChatList' ng-show='hideSavedChatList'>
                <div ng-repeat='channel in savedstreamers'>
                    <div class='unselectable' id='streamerslist'>
                        <div id='logo'>
                            <img ng-src='{{channel.logo}}' width='30' height='30' err-src='img/twitchchat.jpg'></img>
                        </div>
                        <div id='streamer'>{{channel.streamname}}</div>
                        <manage-chats ng-click='closeChat(channel)' style='cursor: pointer; background-color: white; border-radius: 4px;
                            border-color: black; border: 1px solid; font-size: 15px; float: right; margin-top: 5px;'>Close</manage-chats>
                    </div>
                </div>
            </div>

            <div id='searchTwitchForm'>
                <input type='text' id='streamnames' ng-model='searchtext' twitch-search
                       style='position: relative; margin: display:inline-block; width: 99%; height: 30px;
                              font-size: 25px; border: 1px; border-style: solid; border-color: black; z-index: 1;'>
                          </input>

                <div ng-repeat='channel in searchresults'>
                    <multi-chat streamname='{{channel.display_name}}' logo='{{channel.logo}}' savedstreamers='savedstreamers' insertionpoint='center'>
                        <div class='unselectable' id='streamerslist'>
                            <div id='logo'>
                                <img ng-src='{{channel.logo}}' width='30' height='30' err-src='img/twitchchat.jpg'></img>
                                <!-- <img ng-src='' width='30' height='30' err-src='img/twitchchat.jpg'></img> -->
                            </div>
                          <div id='streamer'>{{channel.display_name}}</div>
                        </div>
                    </multi-chat>
                </div>
            </div>

            <!-- chat gets inserted here. -->
            <div id='center'>
                <load-chat savedstreamers='savedstreamers' insertionpoint='center'></load-chat>
            </div>
        </div>
    </body>
</html>
